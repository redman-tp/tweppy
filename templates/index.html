<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tweppy - Modern Twitter Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modern.css') }}">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="logo">
                <i class="fa-brands fa-twitter"></i>
                <span>Tweppy</span>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-tab="dashboard-content">
                        <i class="fa-solid fa-table-columns"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-tab="analytics-content">
                        <i class="fa-solid fa-chart-simple"></i>
                        <span>Analytics</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-tab="scheduler-content">
                        <i class="fa-solid fa-calendar-days"></i>
                        <span>Scheduler</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-tab="settings-content">
                        <i class="fa-solid fa-gear"></i>
                        <span>Settings</span>
                    </a>
                </li>
            </ul>
            <div class="footer-status">
                {% if use_mongodb %}
                    <span class="dot online"></span> MongoDB Connected
                {% else %}
                    <span class="dot offline"></span> DB Connection Failed
                {% endif %}
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Flash Messages -->
            <div class="flash-messages">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}<span class="close-alert">&times;</span></div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard-content" class="tab-content active">
                <header>
                    <h1>Dashboard</h1>
                </header>
                <div id="dashboard-layout" class="dashboard-left-right-container">
                    <div class="dashboard-left">
                        <div class="card stats-card">
                            <h2><i class="fa-solid fa-chart-pie"></i> Statistics</h2>
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <p id="stats-total" class="stat-number">{{ stats.total }}</p>
                                    <p class="stat-label">Total Tweets</p>
                                </div>
                                <div class="stat-item">
                                    <p id="stats-queued" class="stat-number">{{ stats.unposted }}</p>
                                    <p class="stat-label">In Queue</p>
                                </div>
                                <div class="stat-item">
                                    <p id="stats-posted" class="stat-number">{{ stats.posted }}</p>
                                    <p class="stat-label">Posted</p>
                                </div>
                            </div>
                        </div>
                        <div class="card tweet-form-card">
                             <h2><i class="fa-solid fa-pen-to-square"></i> Compose & Queue</h2>
                            <form id="tweet-form" action="/add_tweets" method="post">
                                <textarea id="tweet-input" name="tweets_input" placeholder='"A new tweet..." "And another one..."'></textarea>
                                <div class="form-actions">
                                    <button type="submit" class="btn btn-primary">Add to Queue</button>
                                    <form action="{{ url_for('post_next') }}" method="POST" style="display: inline;">
                                        <button type="submit" class="btn btn-secondary">Post Next Tweet</button>
                                    </form>
                                </div>
                            </form>
                            <button type="button" class="btn btn-secondary">Schedule</button> <!-- Placeholder -->
                        </div>
                    </div>
                    <div class="dashboard-right">
                        <div class="card tabbed-card">
                            <div class="card-tabs">
                                <button class="card-tab-link active" data-tab="queue-tab"><i class="fa-solid fa-list-check"></i> Queue ({{ stats.unposted }})</button>
                                <button class="card-tab-link" data-tab="history-tab"><i class="fa-solid fa-clock-rotate-left"></i> History ({{ history|length }})</button>
                            </div>

                            <div id="queue-tab" class="card-tab-content active">
                                <div class="card-header">
                                    <h3>Tweet Queue</h3>
                                    {% if tweets %}
                                    <form action="{{ url_for('clear_queue') }}" method="POST" onsubmit="return confirm('Are you sure you want to clear the entire queue?');">
                                        <button type="submit" class="btn btn-danger btn-small">Clear All</button>
                                    </form>
                                    {% endif %}
                                </div>
                                <div class="card-content">
                                    <div class="tweet-queue-container">
                                        {% for tweet in tweets %}
                                        <div class="tweet-item">
                                            <p>"{{ tweet.text }}"</p>
                                            <div class="fab-container">
                                                <div class="fab-main">
                                                    <i class="fa-solid fa-ellipsis-vertical"></i>
                                                </div>
                                                <div class="fab-actions">
                                                    <form action="{{ url_for('post_specific_tweet', tweet_id=tweet._id) }}" method="POST" style="display: inline;">
                                                        <button type="submit" class="btn btn-primary btn-small btn-icon" title="Post Now"><i class="fa-solid fa-paper-plane"></i></button>
                                                    </form>
                                                    <button class="btn btn-secondary btn-small btn-icon btn-edit" data-tweet-id="{{ tweet._id }}" data-tweet-text="{{ tweet.text }}" title="Edit Tweet"><i class="fa-solid fa-pencil"></i></button>
                                                    <form action="{{ url_for('delete_tweet', tweet_id=tweet._id) }}" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this tweet?');">
                                                        <button type="submit" class="btn btn-danger btn-small btn-icon" title="Delete Tweet"><i class="fa-solid fa-trash"></i></button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                        {% else %}
                                        <p class="empty-message">The queue is empty. Add some tweets!</p>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>

                            <div id="history-tab" class="card-tab-content">
                                <div class="card-header">
                                    <h3>Post History</h3>
                                    {% if history %}
                                    <form action="{{ url_for('clear_history') }}" method="POST" onsubmit="return confirm('Are you sure you want to clear all post history?');">
                                        <button type="submit" class="btn btn-danger btn-small">Clear History</button>
                                    </form>
                                    {% endif %}
                                </div>
                                <div class="card-content post-history-container">
                                    {% for post in history %}
                                    <div class="history-item">
                                        <p>"{{ post.text }}"</p>
                                        <span class="timestamp">{{ post.posted_at.strftime('%b %d, %H:%M') }} UTC</span>
                                    </div>
                                    {% else %}
                                    <p class="empty-message">No posts in your history yet.</p>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab (Placeholder) -->
            <div id="analytics-content" class="tab-content" style="display: none;">
                <header><h1>Analytics</h1></header>
                <div class="placeholder-content">
                    <i class="fa-solid fa-chart-simple"></i>
                    <p>Advanced analytics and performance metrics will be available here.</p>
                </div>
            </div>

            <!-- Scheduler Tab (Placeholder) -->
            <div id="scheduler-content" class="tab-content" style="display: none;">
                <header><h1>Scheduler</h1></header>
                <div class="placeholder-content">
                    <i class="fa-solid fa-calendar-days"></i>
                    <p>A calendar-based tweet scheduler will be implemented here.</p>
                </div>
            </div>

            <!-- Settings Tab (Placeholder) -->
            <div id="settings-content" class="tab-content" style="display: none;">
                <header><h1>Settings</h1></header>
                <div class="placeholder-content">
                    <i class="fa-solid fa-gear"></i>
                    <p>Application settings and configurations will be available here.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Edit Tweet Modal -->
    <div id="edit-modal" class="modal">
      <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2>Edit Tweet</h2>
        <form id="edit-form" method="POST">
          <textarea id="edit-textarea" name="new_text" rows="4" required></textarea>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </form>
      </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Main tabs
            const mainTabLinks = document.querySelectorAll('.nav-link');
            const mainTabContents = document.querySelectorAll('.tab-content');

            mainTabLinks.forEach(link => {
                link.addEventListener('click', function() {
                    mainTabLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');

                    const tabId = this.getAttribute('data-tab');
                    mainTabContents.forEach(content => {
                        content.style.display = content.id === tabId ? 'block' : 'none';
                    });
                });
            });

            // In-card tabs for Queue/History
            const cardTabLinks = document.querySelectorAll('.card-tab-link');
            const cardTabContents = document.querySelectorAll('.card-tab-content');

            cardTabLinks.forEach(link => {
                link.addEventListener('click', function() {
                    cardTabLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');

                    const tabId = this.getAttribute('data-tab');
                    cardTabContents.forEach(content => {
                        if (content.id === tabId) {
                            content.classList.add('active');
                        } else {
                            content.classList.remove('active');
                        }
                    });
                });
            });

            // Dismissible alerts
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                // Auto-dismiss after 5 seconds
                setTimeout(() => {
                    if (alert) {
                        alert.style.transition = 'opacity 0.5s ease';
                        alert.style.opacity = '0';
                        setTimeout(() => alert.remove(), 500);
                    }
                }, 5000);

                // Manual dismiss
                const closeBtn = alert.querySelector('.close-alert');
                if (closeBtn) {
                    closeBtn.addEventListener('click', function() {
                        if (alert) {
                            alert.style.transition = 'opacity 0.5s ease';
                            alert.style.opacity = '0';
                            setTimeout(() => alert.remove(), 500);
                        }
                    });
                }
            });

            // Modal handling
            const modal = document.getElementById('edit-modal');
            const closeButton = document.querySelector('.close-button');
            const editForm = document.getElementById('edit-form');
            const tweetIdInput = document.getElementById('edit-tweet-id');
            const tweetTextInput = document.getElementById('edit-tweet-text');

            document.querySelectorAll('.btn-edit').forEach(button => {
                button.addEventListener('click', function() {
                    const tweetId = this.getAttribute('data-tweet-id');
                    const tweetText = this.getAttribute('data-tweet-text');

                    tweetIdInput.value = tweetId;
                    tweetTextInput.value = tweetText;
                    editForm.action = `/update_tweet/${tweetId}`;
                    modal.style.display = 'block';
                });
            });

            if (closeButton) {
                closeButton.onclick = function() {
                    modal.style.display = 'none';
                }
            }

            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            }
        });
    </script>
</body>
</html>
