<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tweppy - Modern Twitter Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modern.css') }}">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="logo">
                <i class="fa-brands fa-twitter"></i>
                <span>Tweppy</span>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-tab="dashboard-content">
                        <i class="fa-solid fa-table-columns"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-tab="analytics-content">
                        <i class="fa-solid fa-chart-simple"></i>
                        <span>Analytics</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-tab="scheduler-content">
                        <i class="fa-solid fa-calendar-days"></i>
                        <span>Scheduler</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-tab="settings-content">
                        <i class="fa-solid fa-gear"></i>
                        <span>Settings</span>
                    </a>
                </li>
            </ul>
            <div class="footer-status">
                {% if use_mongodb %}
                    <span class="dot online"></span> MongoDB Connected
                {% else %}
                    <span class="dot offline"></span> DB Connection Failed
                {% endif %}
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Flash Messages -->
            <div class="flash-messages">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}<span class="close-alert">&times;</span></div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard-content" class="tab-content active">
                <header>
                    <h1>Dashboard</h1>
                </header>
                <div id="dashboard-layout" class="dashboard-left-right-container">
                    <div class="dashboard-left">
                        <div class="card stats-card">
                            <h2><i class="fa-solid fa-chart-pie"></i> Statistics</h2>
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <p id="stats-total" class="stat-number">{{ stats.total }}</p>
                                    <p class="stat-label">Total Tweets</p>
                                </div>
                                <div class="stat-item">
                                    <p id="stats-queued" class="stat-number">{{ stats.unposted }}</p>
                                    <p class="stat-label">In Queue</p>
                                </div>
                                <div class="stat-item">
                                    <p id="stats-posted" class="stat-number">{{ stats.posted }}</p>
                                    <p class="stat-label">Posted</p>
                                </div>
                            </div>
                        </div>
                        <!-- Action Buttons Card -->
                        <div class="card actions-card">
                            <h2><i class="fa-solid fa-bolt"></i> Actions</h2>
                            <div class="form-actions">
                                <form action="{{ url_for('start_auto_posting') }}" method="POST" style="display:inline-block; margin-right:8px;">
                                    <button type="submit" class="btn btn-success">Start Auto Post</button>
                                </form>
                                <form action="{{ url_for('stop_auto_posting') }}" method="POST" style="display:inline-block; margin-right:8px;">
                                    <button type="submit" class="btn btn-warning">Pause Auto Post</button>
                                </form>
                                <form action="{{ url_for('clear_stats') }}" method="POST" style="display:inline-block;">
                                    <button type="submit" class="btn btn-danger">Clear Stats</button>
                                </form>
                                <button type="button" id="open-schedule" class="btn btn-secondary" style="margin-left:8px;">Schedule</button>
                            </div>
                        </div>
                        <div class="card tweet-form-card">
                             <h2><i class="fa-solid fa-pen-to-square"></i> Compose & Queue</h2>
                            <form id="tweet-form" action="/add_tweets" method="post">
                                <textarea id="tweet-input" name="tweets_input" placeholder='"A new tweet..." "And another one..."'></textarea>
                                <div class="form-actions">
                                    <button type="submit" name="action" value="queue" class="btn btn-primary">Add to Queue</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="dashboard-right">
                        <div class="card tabbed-card">
                            <div class="card-tabs">
                                <button class="card-tab-link active" data-tab="queue-tab"><i class="fa-solid fa-list-check"></i> Queue ({{ stats.unposted }})</button>
                                <button class="card-tab-link" data-tab="scheduled-tab"><i class="fa-solid fa-calendar-days"></i> Scheduled ({{ scheduled_count }})</button>
                                <button class="card-tab-link" data-tab="history-tab"><i class="fa-solid fa-clock-rotate-left"></i> History ({{ history|length }})</button>
                            </div>

                            <div id="queue-tab" class="card-tab-content active">
                                <div class="card-header">
                                    <h3>Tweet Queue</h3>
                                    {% if tweets %}
                                    <form action="{{ url_for('clear_queue') }}" method="POST" onsubmit="return confirm('Are you sure you want to clear the entire queue?');">
                                        <button type="submit" class="btn btn-danger btn-small">Clear All</button>
                                    </form>
                                    {% endif %}
                                </div>
                                <div class="card-content">
                                    <div class="tweet-queue-container">
                                        {% for tweet in tweets %}
                                        <div class="tweet-item">
                                            <p>"{{ tweet.text }}"</p>
                                            <div class="fab-container">
                                                <div class="fab-main">
                                                    <i class="fa-solid fa-ellipsis-vertical"></i>
                                                </div>
                                                <div class="fab-actions">
                                                    <form action="{{ url_for('post_specific_tweet', tweet_id=tweet._id) }}" method="POST" style="display: inline;">
                                                        <button type="submit" class="btn btn-primary btn-small btn-icon" title="Post Now"><i class="fa-solid fa-paper-plane"></i></button>
                                                    </form>
                                                    <button class="btn btn-secondary btn-small btn-icon btn-edit" data-tweet-id="{{ tweet._id }}" data-tweet-text="{{ tweet.text }}" title="Edit Tweet"><i class="fa-solid fa-pencil"></i></button>
                                                    <form action="{{ url_for('delete_tweet', tweet_id=tweet._id) }}" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this tweet?');">
                                                        <button type="submit" class="btn btn-danger btn-small btn-icon" title="Delete Tweet"><i class="fa-solid fa-trash"></i></button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                        {% else %}
                                        <p class="empty-message">The queue is empty. Add some tweets!</p>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>

                            <div id="scheduled-tab" class="card-tab-content">
                                <div class="card-header">
                                    <h3>Scheduled Tweets</h3>
                                </div>
                                <div class="card-content">
                                    <div class="tweet-queue-container">
                                        {% for item in scheduled %}
                                        <div class="tweet-item" style="position: relative; display:block;">
                                            <div class="timestamp ts" data-iso="{{ item.scheduled_at.isoformat() }}" style="opacity:0.7; font-size: 0.9em; margin-bottom:6px;"></div>
                                            <div class="fab-container" style="position: absolute; right: 8px; top: 8px;">
                                                <div class="fab-main">
                                                    <i class="fa-solid fa-ellipsis-vertical"></i>
                                                </div>
                                                <div class="fab-actions">
                                                    <button class="btn btn-secondary btn-small btn-icon btn-edit-scheduled" data-sid="{{ item._id }}" data-text="{{ item.text }}" data-iso="{{ item.scheduled_at.isoformat() }}" title="Edit Scheduled"><i class="fa-solid fa-pencil"></i></button>
                                                    <form action="{{ url_for('delete_scheduled', sid=item._id) }}" method="POST" style="display: inline;" onsubmit="return confirm('Cancel this scheduled tweet?');">
                                                        <button type="submit" class="btn btn-danger btn-small btn-icon" title="Cancel"><i class="fa-solid fa-trash"></i></button>
                                                    </form>
                                                </div>
                                            </div>
                                            <p>"{{ item.text }}"</p>
                                        </div>
                                        {% else %}
                                        <p class="empty-message">No scheduled tweets.</p>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>

                            <div id="history-tab" class="card-tab-content">
                                <div class="card-header">
                                    <h3>Post History</h3>
                                    {% if history %}
                                    <form action="{{ url_for('clear_history') }}" method="POST" onsubmit="return confirm('Are you sure you want to clear all post history?');">
                                        <button type="submit" class="btn btn-danger btn-small">Clear History</button>
                                    </form>
                                    {% endif %}
                                </div>
                                <div class="card-content post-history-container">
                                    {% for post in history %}
                                    <div class="history-item" style="display:block;">
                                        <div class="timestamp ts" data-iso="{{ post.posted_at.isoformat() }}" style="opacity:0.7; font-size: 0.9em; margin-bottom:6px;"></div>
                                        <p>"{{ post.text }}"</p>
                                    </div>
                                    {% else %}
                                    <p class="empty-message">No posts in your history yet.</p>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab (Placeholder) -->
            <div id="analytics-content" class="tab-content" style="display: none;">
                <header><h1>Analytics</h1></header>
                <div class="placeholder-content">
                    <i class="fa-solid fa-chart-simple"></i>
                    <p>Advanced analytics and performance metrics will be available here.</p>
                </div>
            </div>

            <!-- Scheduler Tab (Placeholder) -->
            <div id="scheduler-content" class="tab-content" style="display: none;">
                <header><h1>Scheduler</h1></header>
                <div class="placeholder-content">
                    <i class="fa-solid fa-calendar-days"></i>
                    <p>A calendar-based tweet scheduler will be implemented here.</p>
                </div>
            </div>

            <!-- Settings Tab (Placeholder) -->
            <div id="settings-content" class="tab-content" style="display: none;">
                <header><h1>Settings</h1></header>
                <div class="placeholder-content">
                    <i class="fa-solid fa-gear"></i>
                    <p>Application settings and configurations will be available here.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Edit Tweet Modal -->
    <div id="edit-modal" class="modal">
      <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2>Edit Tweet</h2>
        <form id="edit-form" method="POST">
          <input type="hidden" id="edit-tweet-id" />
          <textarea id="edit-tweet-text" name="new_text" rows="4" required></textarea>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </form>
      </div>
    </div>

    <!-- Schedule Modal -->
    <div id="schedule-modal" class="modal">
      <div class="modal-content">
        <span class="close-button schedule-close">&times;</span>
        <h2>Schedule Tweet</h2>
        <form id="schedule-form" action="{{ url_for('schedule') }}" method="POST">
          <label for="schedule-text" style="display:block; margin-bottom:6px;">Tweet</label>
          <textarea id="schedule-text" name="scheduled_text" rows="4" placeholder='Your tweet' required></textarea>
          <label for="schedule-datetime" style="display:block; margin:12px 0 6px;">Schedule Time</label>
          <input id="schedule-datetime" name="scheduled_at" type="datetime-local" required />
          <input type="hidden" id="schedule-datetime-utc" name="scheduled_at_utc" />
          <div style="margin-top:14px;">
            <button type="submit" class="btn btn-primary">Schedule</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Edit Scheduled Modal -->
    <div id="edit-scheduled-modal" class="modal">
      <div class="modal-content">
        <span class="close-button edit-scheduled-close">&times;</span>
        <h2>Edit Scheduled Tweet</h2>
        <form id="edit-scheduled-form" method="POST">
          <input type="hidden" id="edit-scheduled-sid" />
          <label for="edit-scheduled-text" style="display:block; margin-bottom:6px;">Tweet</label>
          <textarea id="edit-scheduled-text" name="scheduled_text" rows="4" required></textarea>
          <label for="edit-scheduled-datetime" style="display:block; margin:12px 0 6px;">Schedule Time</label>
          <input id="edit-scheduled-datetime" name="scheduled_at" type="datetime-local" required />
          <input type="hidden" id="edit-scheduled-datetime-utc" name="scheduled_at_utc" />
          <div style="margin-top:14px;">
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </form>
      </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Main tabs
            const mainTabLinks = document.querySelectorAll('.nav-link');
            const mainTabContents = document.querySelectorAll('.tab-content');

            mainTabLinks.forEach(link => {
                link.addEventListener('click', function() {
                    mainTabLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');

                    const tabId = this.getAttribute('data-tab');
                    mainTabContents.forEach(content => {
                        content.style.display = content.id === tabId ? 'block' : 'none';
                    });
                });
            });

            // In-card tabs for Queue/History
            const cardTabLinks = document.querySelectorAll('.card-tab-link');
            const cardTabContents = document.querySelectorAll('.card-tab-content');

            cardTabLinks.forEach(link => {
                link.addEventListener('click', function() {
                    cardTabLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');

                    const tabId = this.getAttribute('data-tab');
                    cardTabContents.forEach(content => {
                        if (content.id === tabId) {
                            content.classList.add('active');
                        } else {
                            content.classList.remove('active');
                        }
                    });
                });
            });

            // Dismissible alerts
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                // Auto-dismiss after 5 seconds
                setTimeout(() => {
                    if (alert) {
                        alert.style.transition = 'opacity 0.5s ease';
                        alert.style.opacity = '0';
                        setTimeout(() => alert.remove(), 500);
                    }
                }, 5000);

                // Manual dismiss
                const closeBtn = alert.querySelector('.close-alert');
                if (closeBtn) {
                    closeBtn.addEventListener('click', function() {
                        if (alert) {
                            alert.style.transition = 'opacity 0.5s ease';
                            alert.style.opacity = '0';
                            setTimeout(() => alert.remove(), 500);
                        }
                    });
                }
            });

            // Edit Modal handling
            const modal = document.getElementById('edit-modal');
            const closeButton = document.querySelector('#edit-modal .close-button');
            const editForm = document.getElementById('edit-form');
            const tweetIdInput = document.getElementById('edit-tweet-id');
            const tweetTextInput = document.getElementById('edit-tweet-text');

            document.querySelectorAll('.btn-edit').forEach(button => {
                button.addEventListener('click', function() {
                    const tweetId = this.getAttribute('data-tweet-id');
                    const tweetText = this.getAttribute('data-tweet-text');

                    tweetIdInput.value = tweetId;
                    tweetTextInput.value = tweetText;
                    editForm.action = `/update_tweet/${tweetId}`;
                    modal.style.display = 'block';
                });
            });

            if (closeButton) {
                closeButton.onclick = function() {
                    modal.style.display = 'none';
                }
            }

            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
                if (event.target == scheduleModal) {
                    scheduleModal.style.display = 'none';
                }
            }

            // Schedule Modal handling
            const openScheduleBtn = document.getElementById('open-schedule');
            const scheduleModal = document.getElementById('schedule-modal');
            const scheduleClose = document.querySelector('#schedule-modal .schedule-close');
            const scheduleDatetime = document.getElementById('schedule-datetime');
            const scheduleDatetimeUtc = document.getElementById('schedule-datetime-utc');
            const scheduleForm = document.getElementById('schedule-form');

            function setDefaultScheduleTime() {
                const now = new Date();
                // default to now + 10 minutes
                now.setMinutes(now.getMinutes() + 10);
                const pad = n => String(n).padStart(2, '0');
                const local = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
                scheduleDatetime.value = local;
                scheduleDatetime.min = local; // prevent past times
            }

            if (openScheduleBtn) {
                openScheduleBtn.addEventListener('click', function() {
                    setDefaultScheduleTime();
                    scheduleModal.style.display = 'block';
                });
            }
            if (scheduleClose) {
                scheduleClose.addEventListener('click', function() {
                    scheduleModal.style.display = 'none';
                });
            }

            // Convert browser local datetime to UTC ISO before submit
            if (scheduleForm) {
                scheduleForm.addEventListener('submit', function(e) {
                    if (scheduleDatetime && scheduleDatetime.value) {
                        const local = new Date(scheduleDatetime.value);
                        const utcIso = new Date(local.getTime() - local.getTimezoneOffset() * 60000).toISOString();
                        scheduleDatetimeUtc.value = utcIso;
                    }
                });
            }

            // Edit Scheduled handling
            const editScheduledModal = document.getElementById('edit-scheduled-modal');
            const editScheduledClose = document.querySelector('#edit-scheduled-modal .edit-scheduled-close');
            const editScheduledForm = document.getElementById('edit-scheduled-form');
            const editScheduledSid = document.getElementById('edit-scheduled-sid');
            const editScheduledText = document.getElementById('edit-scheduled-text');
            const editScheduledDatetime = document.getElementById('edit-scheduled-datetime');
            const editScheduledDatetimeUtc = document.getElementById('edit-scheduled-datetime-utc');

            function isoToLocalDatetimeValue(iso) {
                try {
                    const d = new Date(iso);
                    const pad = n => String(n).padStart(2, '0');
                    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
                } catch { return ''; }
            }

            document.querySelectorAll('.btn-edit-scheduled').forEach(btn => {
                btn.addEventListener('click', function() {
                    const sid = this.getAttribute('data-sid');
                    const text = this.getAttribute('data-text');
                    const iso = this.getAttribute('data-iso');
                    editScheduledSid.value = sid;
                    editScheduledText.value = text;
                    editScheduledDatetime.value = isoToLocalDatetimeValue(iso);
                    // set form action dynamically
                    editScheduledForm.setAttribute('action', `/scheduled/update/${sid}`);
                    editScheduledModal.style.display = 'block';
                });
            });
            if (editScheduledClose) {
                editScheduledClose.addEventListener('click', function() {
                    editScheduledModal.style.display = 'none';
                });
            }
            if (editScheduledForm) {
                editScheduledForm.addEventListener('submit', function() {
                    const val = editScheduledDatetime.value;
                    if (val) {
                        const local = new Date(val);
                        const utcIso = new Date(local.getTime() - local.getTimezoneOffset() * 60000).toISOString();
                        editScheduledDatetimeUtc.value = utcIso;
                    }
                });
            }

            // Render timestamps in browser local from data-iso
            document.querySelectorAll('.ts[data-iso]').forEach(el => {
                try {
                    const d = new Date(el.getAttribute('data-iso'));
                    el.textContent = d.toLocaleString([], { hour: '2-digit', minute: '2-digit', month: 'short', day: '2-digit' });
                } catch {}
            });
        });
    </script>
</body>
</html>
